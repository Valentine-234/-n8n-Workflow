stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - when: always

variables:
  DOCKER_TLS_CERTDIR: ""

default:
  interruptible: true
  retry: 1

# ==================================================
# TEST
# Runs ONLY when MR targets main
# ==================================================
test:
  stage: test
  image: php:8.2-cli
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" &&
            $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
  script:
    - php -v
    - cp .env.example .env
    - php artisan key:generate
    - php artisan test

# ==================================================
# BUILD
# Runs ONLY after merge to env branches
# ==================================================
build:
  stage: build
  image: docker:26
  services:
    - name: docker:26-dind
      command: ["--tls=false"]
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(development|staging|main)$/'
  before_script:
    - |
      if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_PASSWORD" ]; then
        echo "Docker Hub credentials missing"
        exit 1
      fi
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - export IMAGE_NAME=$DOCKERHUB_USERNAME/laravel-app:$CI_COMMIT_SHORT_SHA
    - docker build -t $IMAGE_NAME .
    - docker push $IMAGE_NAME

# ==================================================
# DEPLOY TO DEVELOPMENT
# ==================================================
deploy_dev:
  stage: deploy
  image: alpine/helm:3.14.0
  rules:
    - if: '$CI_COMMIT_BRANCH == "development"'
  before_script:
    - |
      if [ -z "$KUBE_CONFIG_DEV" ]; then
        echo "KUBE_CONFIG_DEV missing"
        exit 1
      fi
  script:
    - echo "$KUBE_CONFIG_DEV" | base64 -d > kubeconfig
    - export KUBECONFIG=$PWD/kubeconfig
    - helm upgrade --install laravel charts/laravel-app \
        --namespace development \
        --create-namespace \
        --set image.repository=$DOCKERHUB_USERNAME/laravel-app \
        --set image.tag=$CI_COMMIT_SHORT_SHA

# ==================================================
# DEPLOY TO STAGING
# ==================================================
deploy_staging:
  stage: deploy
  image: alpine/helm:3.14.0
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
  before_script:
    - |
      if [ -z "$KUBE_CONFIG_STAGING" ]; then
        echo "KUBE_CONFIG_STAGING missing"
        exit 1
      fi
  script:
    - echo "$KUBE_CONFIG_STAGING" | base64 -d > kubeconfig
    - export KUBECONFIG=$PWD/kubeconfig
    - helm upgrade --install laravel charts/laravel-app \
        --namespace staging \
        --create-namespace \
        --set image.repository=$DOCKERHUB_USERNAME/laravel-app \
        --set image.tag=$CI_COMMIT_SHORT_SHA

# ==================================================
# DEPLOY TO PRODUCTION
# Manual approval required
# ==================================================
deploy_prod:
  stage: deploy
  image: alpine/helm:3.14.0
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - |
      if [ -z "$KUBE_CONFIG_PROD" ]; then
        echo "KUBE_CONFIG_PROD missing"
        exit 1
      fi
  script:
    - echo "$KUBE_CONFIG_PROD" | base64 -d > kubeconfig
    - export KUBECONFIG=$PWD/kubeconfig
    - helm upgrade --install laravel charts/laravel-app \
        --namespace production \
        --create-namespace \
        --set image.repository=$DOCKERHUB_USERNAME/laravel-app \
        --set image.tag=$CI_COMMIT_SHORT_SHA

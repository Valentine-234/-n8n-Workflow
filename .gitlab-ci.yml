stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - when: always

variables:
  DOCKER_TLS_CERTDIR: ""

default:
  interruptible: true
  retry: 1

# ====================
# TEST STAGE
# ====================
test:
  stage: test
  image: php:8.2-cli
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - php -v
    - cp .env.example .env
    - php artisan key:generate
    - php artisan test

# ====================
# BUILD STAGE
# ====================
build:
  stage: build
  image: docker:26
  services:
    - name: docker:26-dind
      command: ["--tls=false"]
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(development|staging|main)$/'
  before_script:
    - |
      if [ -z "$DOCKERHUB_USERNAME" ]; then
        echo "ERROR: DOCKERHUB_USERNAME is not set in GitLab CI variables"
        exit 1
      fi
    - |
      if [ -z "$DOCKERHUB_PASSWORD" ]; then
        echo "ERROR: DOCKERHUB_PASSWORD is not set in GitLab CI variables"
        exit 1
      fi
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - export IMAGE_NAME=$DOCKERHUB_USERNAME/laravel-app:$CI_COMMIT_SHORT_SHA
    - docker version
    - docker build -t $IMAGE_NAME .
    - docker push $IMAGE_NAME

# ====================
# DEPLOY TO DEVELOPMENT
# ====================
deploy_dev:
  stage: deploy
  image: alpine/helm:3.14.0
  rules:
    - if: '$CI_COMMIT_BRANCH == "development"'
  before_script:
    - |
      if [ -z "$KUBE_CONFIG_DEV" ]; then
        echo "ERROR: KUBE_CONFIG_DEV is not set in GitLab CI variables"
        exit 1
      fi
  script:
    - echo "$KUBE_CONFIG_DEV" | base64 -d > kubeconfig
    - export KUBECONFIG=$PWD/kubeconfig
    - helm upgrade --install laravel charts/laravel-app \
        --namespace development \
        --create-namespace \
        --set image.repository=$DOCKERHUB_USERNAME/laravel-app \
        --set image.tag=$CI_COMMIT_SHORT_SHA

# ====================
# DEPLOY TO STAGING
# ====================
deploy_staging:
  stage: deploy
  image: alpine/helm:3.14.0
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
  before_script:
    - |
      if [ -z "$KUBE_CONFIG_STAGING" ]; then
        echo "ERROR: KUBE_CONFIG_STAGING is not set in GitLab CI variables"
        exit 1
      fi
  script:
    - echo "$KUBE_CONFIG_STAGING" | base64 -d > kubeconfig
    - export KUBECONFIG=$PWD/kubeconfig
    - helm upgrade --install laravel charts/laravel-app \
        --namespace staging \
        --create-namespace \
        --set image.repository=$DOCKERHUB_USERNAME/laravel-app \
        --set image.tag=$CI_COMMIT_SHORT_SHA

# ====================
# DEPLOY TO PRODUCTION
# ====================
deploy_prod:
  stage: deploy
  image: alpine/helm:3.14.0
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - |
      if [ -z "$KUBE_CONFIG_PROD" ]; then
        echo "ERROR: KUBE_CONFIG_PROD is not set in GitLab CI variables"
        exit 1
      fi
  script:
    - echo "$KUBE_CONFIG_PROD" | base64 -d > kubeconfig
    - export KUBECONFIG=$PWD/kubeconfig
    - helm upgrade --install laravel charts/laravel-app \
        --namespace production \
        --create-namespace \
        --set image.repository=$DOCKERHUB_USERNAME/laravel-app \
        --set image.tag=$CI_COMMIT_SHORT_SHA
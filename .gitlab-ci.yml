stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - when: always

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375

  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE: $DOCKER_USERNAME/boilerplate-task

  AWS_DEFAULT_REGION: us-west-2
  EKS_CLUSTER_NAME: my-eks-cluster

# TEST STAGE
# Runs ONLY when a Merge Request is opened to main
test:
  stage: test
  image: docker:26
  services:
    - name: docker:26-dind
      command: ["--tls=false"]

  script:
    - docker version
    - test -f docker-compose.yml

    # Create .env for CI
    - |
      cat <<EOF > .env
      APP_ENV=testing
      APP_KEY=$APP_KEY
      APP_DEBUG=true

      DB_CONNECTION=mysql
      DB_HOST=mysql
      DB_PORT=3306
      DB_DATABASE=$DB_DATABASE
      DB_USERNAME=$DB_USERNAME
      DB_PASSWORD=$DB_PASSWORD

      MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD

      REDIS_HOST=redis
      CACHE_DRIVER=redis
      QUEUE_CONNECTION=redis
      SESSION_DRIVER=redis
      EOF

    # Start infra services only
    - docker compose up -d mysql redis

    # Wait for MySQL
    - |
      echo "Waiting for MySQL..."
      for i in $(seq 1 30); do
        docker compose exec -T mysql \
          mysqladmin ping -h 127.0.0.1 -p"$MYSQL_ROOT_PASSWORD" --silent && break
        sleep 2
      done

    # Run Laravel migrations & tests
    - docker compose run --rm ap-app-ci artisan migrate --force
    - docker compose run --rm ap-app-ci artisan test

  after_script:
    - docker compose logs mysql redis || true

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" &&
            $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'

# BUILD STAGE
# Runs AFTER merge to development / staging / main
build:
  stage: build
  image: docker:26
  services:
    - name: docker:26-dind
      command: ["--tls=false"]

  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA

  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(development|staging|main)$/'

# DEPLOY STAGE
# Helm DRY-RUN (no real EKS required)

deploy:
  stage: deploy
  image: alpine:3.19

  before_script:
    - apk add --no-cache bash curl helm

  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "development" ]; then
        NAMESPACE=development
      elif [ "$CI_COMMIT_BRANCH" = "staging" ]; then
        NAMESPACE=staging
      else
        NAMESPACE=production
      fi

      helm upgrade --install laravel-app helm-chart/laravel-app \
        --namespace $NAMESPACE \
        --create-namespace \
        --set image.repository=$DOCKER_IMAGE \
        --set image.tag=$CI_COMMIT_SHORT_SHA \
        --dry-run

  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(development|staging|main)$/'

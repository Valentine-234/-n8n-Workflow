stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - when: always

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  IMAGE_NAME: "$DOCKERHUB_USERNAME/laravel-app:$CI_COMMIT_SHORT_SHA"

# --------------------
# TEST (Merge Requests to dev or main)
# --------------------
test:
  stage: test
  image: docker:25
  services:
    - name: docker:25-dind
      command: ["--tls=false"]
  script:
    - docker version
    - docker compose -f docker-compose.test.yml up --abort-on-container-exit
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" &&
            $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^(dev|main)$/'

# --------------------
# BUILD (Push to dev or main)
# --------------------
build:
  stage: build
  image: docker:25
  services:
    - name: docker:25-dind
      command: ["--tls=false"]

  before_script:
    # ---- HARD FAIL WITH CLEAR ERROR ----
    - |
      if [ -z "$DOCKERHUB_USERNAME" ]; then
        echo "ERROR: DOCKERHUB_USERNAME is not set in GitLab CI variables"
        exit 1
      fi

      if [ -z "$DOCKERHUB_PASSWORD" ]; then
        echo "ERROR: DOCKERHUB_PASSWORD is not set in GitLab CI variables"
        exit 1
      fi

    # ---- SAFE DOCKER LOGIN ----
    - echo "$DOCKERHUB_PASSWORD" | docker login \
        --username "$DOCKERHUB_USERNAME" \
        --password-stdin

  script:
    - docker build -t "$IMAGE_NAME" .
    - docker push "$IMAGE_NAME"

  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" &&
            $CI_COMMIT_BRANCH =~ /^(dev|main)$/'

# --------------------
# DEPLOY (Push to dev or main)
# --------------------
deploy:
  stage: deploy
  image: docker:25
  services:
    - name: docker:25-dind
      command: ["--tls=false"]

  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ]; then
        docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
        PORT=8000
      elif [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
        PORT=80
      else
        echo "Unsupported branch: $CI_COMMIT_BRANCH"
        exit 1
      fi

    - sleep 20
    - curl -f "http://localhost:$PORT/health"

  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" &&
            $CI_COMMIT_BRANCH =~ /^(dev|main)$/'

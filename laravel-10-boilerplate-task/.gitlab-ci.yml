stages:
  - test
  - build
  - deploy

variables:
  IMAGE_NAME: $DOCKERHUB_USERNAME/laravel-app:$CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: ""

# --------------------
# TEST (PRs to dev, staging, main)
# --------------------
test:
  stage: test
  image: docker:25
  services:
    - docker:25-dind
  script:
    - docker-compose -f docker-compose.test.yml up --abort-on-container-exit
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" &&
            ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" ||
             $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "staging" ||
             $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main")'

# --------------------
# BUILD
# --------------------
build:
  stage: build
  image: docker:25
  services:
    - docker:25-dind
  before_script:
    - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
  script:
    - docker build -t $IMAGE_NAME .
    - docker push $IMAGE_NAME
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(development|staging|main)$/'

# --------------------
# DEPLOY + HEALTH CHECK
# --------------------
deploy:
  stage: deploy
  image: docker:25
  services:
    - docker:25-dind
  script:
    - export IMAGE_NAME=$IMAGE_NAME
    - |
      if [ "$CI_COMMIT_BRANCH" = "development" ]; then
        docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
        PORT=8000
      elif [ "$CI_COMMIT_BRANCH" = "staging" ]; then
        docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d
        PORT=8080
      else
        docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
        PORT=80
      fi

    # Health check validation
    - sleep 20
    - curl -f http://localhost:$PORT/health
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(development|staging|main)$/'
